# 8x8 HDMI Matrix Hub - Docker Compose
#
# Supports HDCVT HDP-MXC88A-based matrix switches including:
# OREI BK-808, BZBGEAR BG-8K-88MA, A-NeuVideo ANI-8-8K60-S, and more.
#
# Usage:
#   docker-compose up -d              # Start with UC integration (full)
#   docker-compose up -d api-only     # Start API-only mode
#   docker-compose logs -f            # View logs
#   docker-compose down               # Stop integration

services:
  # ==========================================================================
  # Full service with UC integration (default)
  # ==========================================================================
  hdmi-matrix-hub:
    build:
      context: .
      target: full
    container_name: hdmi-matrix-hub
    restart: unless-stopped
    profiles:
      - full
      - default

    ports:
      - "9095:9095" # UC WebSocket integration
      - "8080:8080" # REST API for Flic, Home Assistant, etc.

    volumes:
      - ./data:/data

    environment:
      - UC_CONFIG_HOME=/data
      - UC_DISABLE_MDNS_PUBLISH=false
      - UC_INTEGRATION_INTERFACE=0.0.0.0
      - UC_INTEGRATION_HTTP_PORT=9095
      - REST_API_PORT=8080
      - UC_ENABLED=true
      - WEBUI_ENABLED=true
      - LOG_LEVEL=INFO

    stop_grace_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # API-only service (no UC dependencies, smaller image)
  # ==========================================================================
  api-only:
    build:
      context: .
      target: api-only
    container_name: hdmi-matrix-api
    restart: unless-stopped
    profiles:
      - api-only

    ports:
      - "8080:8080" # REST API only

    volumes:
      - ./data:/data

    environment:
      - REST_API_PORT=8080
      - UC_ENABLED=false
      - WEBUI_ENABLED=true
      - LOG_LEVEL=INFO

    stop_grace_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
